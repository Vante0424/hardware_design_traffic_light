IOY0         EQU   0600H          ;片选IOY0对应的端口始地址
MY8255_A     EQU   IOY0+00H*2     ;8255的A口地址
MY8255_B     EQU   IOY0+01H*2     ;8255的B口地址
MY8255_C     EQU   IOY0+02H*2     ;8255的C口地址
MY8255_MODE  EQU   IOY0+03H*2     ;8255的控制寄存器地址


CODE	SEGMENT
		ASSUME CS:CODE
START:	MOV DX, MY8255_MODE
		MOV AL, 10000001B
		OUT DX, AL       	;8255控制字写入
		MOV AL,00110000B
		MOV DX,0646H
		OUT DX,AL         	;8254控制字写入
		MOV DX,0640H
		MOV AL,00H
		OUT	DX,AL
		MOV AL,48H        	;18432HZ对应计数初值
		OUT DX,AL          	;端口0写入计数
GLOB:	MOV	CX,3CH         		;60秒
JTD:	MOV DX,MY8255_C
   		IN  AL,DX 		;获取计数器状态
   		AND AL,00000001B
   		CMP AL,00000001B   	;判断C口的最后一位的状态，判断一秒是否到达
   		JC  KEEP
		DEC CX
		MOV DX,0640H
		MOV AL,00H
		OUT	DX,AL
		MOV AL,48H         ;18432HZ对应计数初值(时间到达1秒技计数初值重置）
		OUT DX,AL   
KEEP:	    
		MOV AL,CL
		CMP AL,1EH			
		JBE	DIS			;小于30秒，数码管显示
		SUB	AL,1EH
DIS:	XOR AH,AH
		MOV BL,0AH
		DIV BL
		CALL NUMBER
		MOV DX,MY8255_A			;十位数码管显示数字
		OUT DX,AL
		MOV DX,MY8255_C
		MOV AL,01111111B
		OUT DX,AL        		;选中十位数字的数码管
		MOV DX,MY8255_C
		MOV AL,11111111B
		OUT DX,AL   			;数码管全灭
		MOV AL,AH
		CALL NUMBER
		MOV DX,MY8255_A			;个位数码管显示数字
		OUT DX,AL
		MOV DX,MY8255_C
		MOV AL,10111111B
		OUT DX,AL        		;选中个位数字的数码管
		MOV DX,MY8255_C
		MOV AL,11111111B
		OUT DX,AL   			;数码管全灭
		CALL LED
		
		OR	CX,CX
		JNZ JTD
		JMP GLOB

	MOV AH,4CH
	INT 21H
		
NUMBER 	PROC 	NEAR
		CMP AL,0AH
		JB	NUM
		SUB AL,0AH
NUM:	CMP AL,00000000B
		JZ ZERO
		CMP AL,00000001B
		JZ ONE
		CMP AL,00000010B
		JZ TWO
		CMP AL,00000011B
		JZ THREE
		CMP AL,00000100B
		JZ FOUR
		CMP AL,00000101B
		JZ FIVE 
		CMP AL,00000110B
		JZ SIX
		CMP AL,00000111B
		JZ SEVEN
		CMP AL,00001000B
		JZ EIGHT
		CMP AL,00001001B
		JZ NINE
		
		
ZERO:	MOV AL,3FH
		JMP PEND
ONE:	MOV AL,06H
		JMP PEND
TWO:	MOV AL,5BH
		JMP PEND
THREE: 	MOV AL,4FH
		JMP PEND
FOUR:	MOV AL,66H
		JMP PEND
FIVE:	MOV AL,6DH
		JMP PEND
SIX:	MOV AL,7DH
		JMP PEND
SEVEN:	MOV AL,07H
		JMP PEND
EIGHT: 	MOV AL,7FH
		JMP PEND
NINE:	MOV AL,6FH

PEND: 	RET
NUMBER ENDP


LED		PROC	NEAR
		
		MOV DX,MY8255_C
   		IN  AL,DX 			;获取计数器状态
   		AND AL,00001000B
   		CMP AL,00001000B
		JC  LED5          		;紧急情况	
		
		CMP CX,23H			;判断是否为前30秒钟
		JA LED1
		CMP CX,1EH			;判断秒时变黄灯
		JA LED2
		CMP CX,05H
		JA LED3
		JMP LED4
			
							
LED1:	MOV DX,MY8255_B			;东西绿灯,南北红灯
		MOV AL,00001100B
		OUT DX,AL
		JMP PEND1
LED2:	MOV DX,MY8255_B			;东西黄灯,南北红灯
		MOV AL,00010100B
		OUT DX,AL
		JMP PEND1
LED3:	MOV DX,MY8255_B			;南北绿灯,东西红灯
		MOV AL,00100001B
		OUT DX,AL
		JMP PEND1
LED4:	MOV DX,MY8255_B			;南北黄灯,东西红灯
		MOV AL,00100010B
		OUT DX,AL
		JMP PEND1
LED5:  MOV DX,MY8255_B         		;紧急情况，全是红灯
        MOV AL,00100100B
        OUT DX,AL
PEND1:	RET
LED	ENDP
			
CODE	ENDS
		END  START